"""
Script de teste para o Sistema de Orquestra√ß√£o de Agentes
"""

import asyncio
import json
import os
import sys
from datetime import datetime

# Adiciona o diret√≥rio atual ao path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from orchestration_system import OrchestrationSystem, OrchestrationWorkflow
from config_utils import ConfigManager


async def test_basic_functionality():
    """Testa funcionalidades b√°sicas do sistema"""
    print("=== Teste de Funcionalidades B√°sicas ===")
    
    # Inicializa sistema
    system = OrchestrationSystem()
    
    try:
        await system.initialize()
        print("‚úì Sistema inicializado com sucesso")
        
        # Testa status do sistema
        status = system.get_system_status()
        print(f"‚úì Status do sistema obtido: {status['agents_count']} agentes dispon√≠veis")
        
        # Lista agentes dispon√≠veis
        agents = system.get_available_agents()
        print(f"‚úì Agentes dispon√≠veis: {len(agents)}")
        for agent in agents:
            print(f"  - {agent['name']}: {agent['description']}")
        
        return system
        
    except Exception as e:
        print(f"‚úó Erro na inicializa√ß√£o: {str(e)}")
        return None


async def test_orchestrator_creation(system):
    """Testa cria√ß√£o de orquestradores"""
    print("\n=== Teste de Cria√ß√£o de Orquestradores ===")
    
    if not system or not system.agents:
        print("‚úó Sistema n√£o dispon√≠vel ou sem agentes")
        return False
    
    try:
        # Testa cria√ß√£o de orquestrador sequencial
        agent_names = list(system.agents.keys())[:2]  # Pega os primeiros 2 agentes
        
        orchestrator_name = await system.create_orchestrator(
            name="teste_sequencial",
            pattern="sequential",
            agent_names=agent_names
        )
        print(f"‚úì Orquestrador sequencial criado: {orchestrator_name}")
        
        # Testa cria√ß√£o de orquestrador concorrente
        orchestrator_name = await system.create_orchestrator(
            name="teste_concorrente",
            pattern="concurrent",
            agent_names=agent_names
        )
        print(f"‚úì Orquestrador concorrente criado: {orchestrator_name}")
        
        # Lista orquestradores
        orchestrators = system.get_orchestrators()
        print(f"‚úì Orquestradores criados: {len(orchestrators)}")
        for orch in orchestrators:
            print(f"  - {orch['name']}: {orch['pattern']} com {len(orch['agents'])} agentes")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erro na cria√ß√£o de orquestradores: {str(e)}")
        return False


async def test_orchestration_execution(system):
    """Testa execu√ß√£o de orquestra√ß√µes"""
    print("\n=== Teste de Execu√ß√£o de Orquestra√ß√µes ===")
    
    if not system:
        print("‚úó Sistema n√£o dispon√≠vel")
        return False
    
    # Verifica se h√° chave API configurada
    config_manager = ConfigManager()
    llm_config = config_manager.get_llm_config()
    
    if not llm_config.api_key:
        print("‚ö† Chave API n√£o configurada - simulando execu√ß√£o")
        return await simulate_orchestration_execution(system)
    
    try:
        # Testa orquestra√ß√£o sequencial
        result = await system.execute_orchestration(
            orchestrator_name="teste_sequencial",
            task="Analise o mercado de tecnologia e crie um relat√≥rio resumido",
            context={"formato": "resumo executivo"}
        )
        
        print(f"‚úì Orquestra√ß√£o sequencial executada:")
        print(f"  - Sucesso: {result.get('success', False)}")
        print(f"  - Tempo: {result.get('execution_time', 0):.2f}s")
        
        if result.get('success'):
            print(f"  - Resultado final dispon√≠vel")
        else:
            print(f"  - Erro: {result.get('error', 'Desconhecido')}")
        
        # Testa orquestra√ß√£o concorrente
        result = await system.execute_orchestration(
            orchestrator_name="teste_concorrente",
            task="Crie ideias para uma campanha de marketing digital",
            context={"p√∫blico": "jovens adultos", "produto": "aplicativo m√≥vel"}
        )
        
        print(f"‚úì Orquestra√ß√£o concorrente executada:")
        print(f"  - Sucesso: {result.get('success', False)}")
        print(f"  - Tempo: {result.get('execution_time', 0):.2f}s")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erro na execu√ß√£o de orquestra√ß√µes: {str(e)}")
        return False


async def simulate_orchestration_execution(system):
    """Simula execu√ß√£o de orquestra√ß√µes quando n√£o h√° API key"""
    try:
        # Simula resultado de orquestra√ß√£o sequencial
        print("‚úì Simula√ß√£o de orquestra√ß√£o sequencial:")
        print("  - Sucesso: True (simulado)")
        print("  - Tempo: 2.5s (simulado)")
        print("  - Agentes processaram sequencialmente")
        
        # Simula resultado de orquestra√ß√£o concorrente
        print("‚úì Simula√ß√£o de orquestra√ß√£o concorrente:")
        print("  - Sucesso: True (simulado)")
        print("  - Tempo: 1.8s (simulado)")
        print("  - Agentes processaram em paralelo")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erro na simula√ß√£o: {str(e)}")
        return False


async def test_workflow_functionality(system):
    """Testa funcionalidade de workflows"""
    print("\n=== Teste de Workflows ===")
    
    if not system:
        print("‚úó Sistema n√£o dispon√≠vel")
        return False
    
    try:
        # Cria gerenciador de workflow
        workflow_manager = OrchestrationWorkflow(system)
        
        # Define um workflow de exemplo
        workflow_steps = [
            {
                "name": "An√°lise Inicial",
                "orchestrator": "teste_sequencial"
            },
            {
                "name": "Gera√ß√£o de Ideias",
                "orchestrator": "teste_concorrente"
            }
        ]
        
        workflow_manager.define_workflow(
            name="workflow_completo",
            steps=workflow_steps,
            description="Workflow de exemplo com an√°lise e gera√ß√£o de ideias"
        )
        
        print("‚úì Workflow definido com sucesso")
        
        # Lista workflows
        workflows = workflow_manager.get_workflows()
        print(f"‚úì Workflows dispon√≠veis: {len(workflows)}")
        for workflow in workflows:
            print(f"  - {workflow['name']}: {len(workflow['steps'])} etapas")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erro no teste de workflows: {str(e)}")
        return False


async def test_metrics_collection(system):
    """Testa coleta de m√©tricas"""
    print("\n=== Teste de M√©tricas ===")
    
    if not system:
        print("‚úó Sistema n√£o dispon√≠vel")
        return False
    
    try:
        # Obt√©m m√©tricas
        metrics = system.get_metrics()
        
        print("‚úì M√©tricas coletadas:")
        print(f"  - Total de orquestra√ß√µes: {metrics['orchestrations_count']}")
        print(f"  - Sucessos: {metrics['successful_orchestrations']}")
        print(f"  - Falhas: {metrics['failed_orchestrations']}")
        print(f"  - Tempo m√©dio: {metrics['average_execution_time']:.2f}s")
        
        if metrics['patterns_usage']:
            print("  - Uso de padr√µes:")
            for pattern, count in metrics['patterns_usage'].items():
                print(f"    * {pattern}: {count}")
        
        if metrics['agents_usage']:
            print("  - Uso de agentes:")
            for agent, count in metrics['agents_usage'].items():
                print(f"    * {agent}: {count}")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erro na coleta de m√©tricas: {str(e)}")
        return False


async def test_configuration():
    """Testa sistema de configura√ß√£o"""
    print("\n=== Teste de Configura√ß√£o ===")
    
    try:
        # Testa carregamento de configura√ß√£o
        config_manager = ConfigManager()
        
        print("‚úì Configura√ß√£o carregada:")
        print(f"  - Provedor LLM: {config_manager.config['llm']['provider']}")
        print(f"  - Modelo: {config_manager.config['llm']['model_name']}")
        print(f"  - Padr√£o de orquestra√ß√£o: {config_manager.config['orchestration']['default_pattern']}")
        
        # Testa configura√ß√£o do LLM
        llm_config = config_manager.get_llm_config()
        print(f"‚úì Configura√ß√£o LLM obtida: {llm_config.provider}")
        
        # Verifica se h√° chave API
        if llm_config.api_key:
            print("‚úì Chave API configurada")
        else:
            print("‚ö† Chave API n√£o configurada (configure OPENAI_API_KEY)")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erro no teste de configura√ß√£o: {str(e)}")
        return False


async def run_all_tests():
    """Executa todos os testes"""
    print("üöÄ Iniciando testes do Sistema de Orquestra√ß√£o de Agentes")
    print("=" * 60)
    
    # Teste de configura√ß√£o
    config_ok = await test_configuration()
    
    # Teste de funcionalidades b√°sicas
    system = await test_basic_functionality()
    
    if system:
        # Testes que dependem do sistema
        orchestrator_ok = await test_orchestrator_creation(system)
        
        if orchestrator_ok:
            execution_ok = await test_orchestration_execution(system)
            workflow_ok = await test_workflow_functionality(system)
        else:
            execution_ok = workflow_ok = False
        
        metrics_ok = await test_metrics_collection(system)
        
        # Finaliza sistema
        await system.shutdown()
    else:
        orchestrator_ok = execution_ok = workflow_ok = metrics_ok = False
    
    # Resumo dos testes
    print("\n" + "=" * 60)
    print("üìä Resumo dos Testes:")
    print(f"‚úì Configura√ß√£o: {'OK' if config_ok else 'FALHOU'}")
    print(f"‚úì Funcionalidades B√°sicas: {'OK' if system else 'FALHOU'}")
    print(f"‚úì Cria√ß√£o de Orquestradores: {'OK' if orchestrator_ok else 'FALHOU'}")
    print(f"‚úì Execu√ß√£o de Orquestra√ß√µes: {'OK' if execution_ok else 'FALHOU'}")
    print(f"‚úì Workflows: {'OK' if workflow_ok else 'FALHOU'}")
    print(f"‚úì M√©tricas: {'OK' if metrics_ok else 'FALHOU'}")
    
    total_tests = 6
    passed_tests = sum([config_ok, bool(system), orchestrator_ok, execution_ok, workflow_ok, metrics_ok])
    
    print(f"\nüéØ Resultado: {passed_tests}/{total_tests} testes passaram")
    
    if passed_tests == total_tests:
        print("üéâ Todos os testes passaram! Sistema funcionando corretamente.")
    elif passed_tests >= total_tests * 0.8:
        print("‚úÖ Maioria dos testes passou. Sistema funcional com algumas limita√ß√µes.")
    else:
        print("‚ö†Ô∏è V√°rios testes falharam. Verifique a configura√ß√£o e depend√™ncias.")
    
    return passed_tests == total_tests


if __name__ == "__main__":
    # Executa todos os testes
    success = asyncio.run(run_all_tests())

